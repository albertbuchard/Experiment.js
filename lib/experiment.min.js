!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("lodash"),require("experiment-babylon-js"),require("experiment-boxes"),require("experiment-mathjs"),require("jquery")):"function"==typeof define&&define.amd?define("experiment",["lodash","experiment-babylon-js","experiment-boxes","experiment-mathjs","jquery"],t):"object"==typeof exports?exports.experiment=t(require("lodash"),require("experiment-babylon-js"),require("experiment-boxes"),require("experiment-mathjs"),require("jquery")):e.experiment=t(e.lodash,e["experiment-babylon-js"],e["experiment-boxes"],e["experiment-mathjs"],e.jquery)}(this,function(e,t,n,a,r){return function(e){function t(a){if(n[a])return n[a].exports;var r=n[a]={i:a,l:!1,exports:{}};return e[a].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,a){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:a})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=14)}([function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}function r(){}function i(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";throw new Error("Missing parameter "+e)}function o(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var a=0;a<t.length;a++)if(void 0===t[a])throw new Error("Argument "+a+" is undefined.");return!0}function s(e){for(var t=arguments.length,n=Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];if(n.allHaveConstructor(e)===!1)throw new Error("Wrong constructor in arguments.");return!0}function l(e){return e&&"function"==typeof e.then&&"function"==typeof e.catch}function u(e){return new Promise(function(t){setTimeout(t,e)})}function d(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i();return new Promise(function(n){var a=w.default.random(e,t);setTimeout(n,a)})}function c(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i(),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[];return 0===t?new Promise(function(e){e(r)}):e.apply(n,a).then(function(i){return r=r.concat(i),c(e,t-1,n,a,r)})}function h(){var e=this;this.resolve=null,this.reject=null,this.promise=new Promise(function(t,n){e.resolve=t,e.reject=n}),Object.freeze(this)}function g(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i(),n=[];if("function"==typeof e)for(var a=0;a<t;a++)n=n.concat(e(a));else for(var r=0;r<t;r++)n=n.concat(e);return n}function f(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i(),t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(e.constructor!==Array)throw new Error("samplePermutation: sequence needs to be an array.");null===n&&(n=e.length);for(var a=e.slice(0),r=[],o=void 0;t&&r.length<n||!t&&a.length;){var s=Math.floor(Math.random()*a.length);o=t?a[s]:a.splice(s,1),r=r.concat(o)}return r}function v(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i(),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=[],r=0;r<e;r++){a[r]=[];for(var o=0;o<t;o++)a[r][o]=n}return a}function y(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i();e=M.default.matrix(e);var n=e.size()[0];return M.default.subset(e,M.default.index(t,M.default.range(0,n)))}function m(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;e=M.default.matrix(e);var n=e.size()[0];null===t&&(t=M.default.range(0,n-1)),t.constructor!==Array&&(t=[t]);for(var a=[],r=0;r<t.length;r++)a.push(M.default.sum(y(e,t[r])));return a}function p(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=e.length,a=[],r=0;r<n;r++)t&&(e[r][r]=t),a.push(e[r][r]);return[a,e]}Object.defineProperty(t,"__esModule",{value:!0}),t.noop=t.debugError=t.debugWarn=t.debuglog=t.mandatory=t.mustBeDefined=t.mustHaveConstructor=t.looksLikeAPromise=t.delay=t.jitter=t.recurse=t.Deferred=t.rep=t.samplePermutation=t.matrix=t.getRow=t.rowSum=t.diag=t.String=t.Array=void 0;var b=n(1),w=a(b),k=n(12),M=a(k),E=n(7),S=E.DEBUG_MODE_ON?console.log.bind(console):r,O=E.DEBUG_MODE_ON?console.warn.bind(console):r,_=E.DEBUG_MODE_ON?console.error.bind(console):r;String.prototype.indicesOf=function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i(),t=this,n=[],a=0;a<t.length;a++)t.substr(a,e.length)===e&&n.push(a);return n.length?n:-1},Array.prototype.hasNeighbouringRepeat=function(){for(var e=null,t=0;t<this.length;t++){if(e===this[t])return!0;e=this[t]}return!1},Array.prototype.toCsv=function(){var e=[];return this.forEach(function(t,n){var a=t.join(",");e.push(0===n?"data:text/csv;charset=utf-8,"+a:a)}),e.join("\n")},Array.prototype.uniqueValues=function(){for(var e={},t=[],n=0;n<this.length;n++)e.hasOwnProperty(this[n])||(t.push(this[n]),e[this[n]]=1);return t},Array.prototype.min=function(){var e=this.uniqueValues();if(e.allHaveConstructor(Number)){for(var t=e[0],n=0;n<e.length;n++)e[n]<t&&(t=e[n]);return t}return NaN},Array.prototype.max=function(){var e=this.uniqueValues();if(e.allHaveConstructor(Number)){for(var t=e[0],n=0;n<e.length;n++)e[n]>t&&(t=e[n]);return t}return NaN},Array.prototype.getXY=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(null!==e){if(e.constructor!==Array)throw new Error("Array.getXY: x needs to be an array.");if(e.length!==this.length)throw new Error("Array.getXY: x needs to be of the same length as array")}else S("Array.getXY: x === null, x will be taken as the index of each value.");for(var t=[],n=0;n<this.length;n++)null!==e?t.push({x:e[n],y:this[n]}):t.push({x:n,y:this[n]});return t},Array.prototype.average=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"global",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;if("global"===e){var n=this.sum();if(!isNaN(n))return n/this.length}else{if("sliding"===e){for(var a=[],r=0;r<this.length;r++){var i=r+t;i>this.length&&(i=this.length);var o=this.slice(r,i),s=o.sum();isNaN(s)||a.push(s/o.length)}return a}if("bins"===e){for(var l=[],u=0;u<this.length;){var d=u+t;if(d>this.length)break;var c=this.slice(u,d),h=c.sum();isNaN(h)||l.push(h/c.length),u=d}return l}}},Array.prototype.sum=function(){for(var e=0,t=0;t<this.length;t++){if(isNaN(this[t]))return NaN;e+=this[t]}return e},Array.prototype.integrate=function(){for(var e=0,t=[],n=0;n<this.length;n++){if(isNaN(this[n]))return NaN;e+=this[n],t.push(e)}return t},Array.prototype.equals=function(e){for(var t=[],n=null,a=0,r=this.length;a<r;++a)n=this[a]===e,t.push(n);return t},Array.prototype.ntrue=function(){for(var e=0,t=null,n=0,a=this.length;n<a;++n)t=this[n]===!0?1:0,e+=t;return e},Array.prototype.nEquals=function(e){return this.equals(e).ntrue()},Array.prototype.indicesOf=function(e){for(var t=[],n=0,a=this.length;n<a;n++)this[n]===e&&t.push(n);return t},Array.prototype.exclude=function(e){for(var t=[],n=0,a=this.length;n<a;++n){for(var r=!0,i=0;i<e.length;++i)this[n]===e[i]&&(r=!1);r&&t.push(this[n])}return t},Array.prototype.allHaveConstructor=function(e){for(var t=0;t<this.length;t++)if(this[t].constructor!==e)return!1;return!0},Array.prototype.includes=function(e){for(var t=0;t<e.length;t++)if(this.indexOf(e[t])===-1)return!1;return!0},t.Array=Array,t.String=String,t.diag=p,t.rowSum=m,t.getRow=y,t.matrix=v,t.samplePermutation=f,t.rep=g,t.Deferred=h,t.recurse=c,t.jitter=d,t.delay=u,t.looksLikeAPromise=l,t.mustHaveConstructor=s,t.mustBeDefined=o,t.mandatory=i,t.debuglog=S,t.debugWarn=O,t.debugError=_,t.noop=r},function(t,n){t.exports=e},function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=a(i),s=n(0),l=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,s.mandatory)("flag"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,s.mandatory)("timeStamp"),a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;r(this,e),this.flag=t,this.happenedAt=n,this.handled=!1,this.stored=!1;var i={belongsTo:"globalLog",handledAt:null,storedAt:null};this.data=o.default.extend(i,a)};t.default=l},function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),s=n(1),l=a(s),u=n(0),d=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,u.mandatory)(),a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;r(this,t),this._parent=n,a&&(this._subjectID=a),this.automaticID=!0,this.VALUE_FOR_NA=null,this.FLAG_EVENT_NOFLAG="EVENT_UNFLAGGED",this.dataTables={};var i=["id","flag","happenedAt","data"];this.addTable("globalLog",i),this.restURL=null,this.isNode=!1,void 0!==e&&e.exports&&(this.isNode=!0)}return o(t,[{key:"addTable",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,u.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,u.mandatory)();if(l.default.has(this.dataTables,e))throw new Error("DataManager: Data table with name '"+e+"' already exists");this.dataTables[e]={};for(var n=0;n<t.length;n++)this.dataTables[e][t[n]]=[];l.default.indexOf(t,"id")===-1&&(this.dataTables[e].id=[])}},{key:"hasTable",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,u.mandatory)();return!!l.default.has(this.dataTables,e)}},{key:"addRows",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,u.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,u.mandatory)();if(!this.isValidRows(e,t))throw new Error("DataManager: Row is of invalid format.");var n=l.default.keys(t),a=l.default.without(l.default.keys(this.dataTables[e]),"id");l.default.indexOf(n,"id")===-1&&this.automaticID&&(this.dataTables[e].id=this.dataTables[e].id.concat(this.generateIds(e,t[n[0].length])));for(var r=0;r<a.length;r++)this.dataTables[e][a[r]]=this.dataTables[e][a[r]].concat(t[a[r]]);var i=void 0===t.length?1:t.length;(0,u.debuglog)("DataManager: added "+i+" rows to "+e+" data table.")}},{key:"generateIds",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,u.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(!l.default.has(this.dataTables,e))throw new Error("DataManager: Data table with name '"+e+"' does not exists");if(!l.default.has(this.dataTables[e],"id"))throw new Error("DataManager: Data table with name '"+e+"' does not have an 'id' field");var n=0;return 0!==this.dataTables[e].id.length&&(n=l.default.max(this.dataTables[e].id)+1),l.default.range(n,n+t)}},{key:"getEmptyRow",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,u.mandatory)();if(!l.default.has(this.dataTables,e))throw new Error("DataManager: Data table with name '"+e+"' does not exists");for(var t={},n=l.default.keys(this.dataTables[e]),a=0;a<n.length;a++)t[n[a]]=[];return t}},{key:"isValidRows",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,u.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,u.mandatory)();if(!l.default.has(this.dataTables,e))throw new Error("DataManager: Data table with name '"+e+"' does not exists");if("object"!==(void 0===t?"undefined":i(t)))return!1;for(var n=l.default.keys(this.dataTables[e]),a=l.default.keys(t),r=null,o=0;o<n.length;o++)if(l.default.indexOf(a,n[o])!==-1){if(t[n[o]].constructor===u.Array)if(null===r)r=t[n[o]].length;else{var s=t[n[o]].length;if(r!==s)return!1}else if(null!==r)return!1}else if("id"!==n[o]&&!this.automaticID)return(0,u.debugError)("DataManager: Invalid row, does not contain column "+n[o]+" of dataTable"+e),!1;return!0}},{key:"toCsv",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,u.mandatory)();if(!l.default.has(this.dataTables,e))throw new Error("DataManager: Data table with name '"+e+"' does not exists");for(var t=l.default.keys(this.dataTables[e]),n=[],a=0;a<t[0].length;a++){for(var r=[],i=0;i<t.length;i++)r.push(t[i][a]);var o=r.join(",");n.push(0===a?"data:text/csv;charset=utf-8,"+o:o)}return n.join("\n")}},{key:"toDataArray",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,u.mandatory)();if(!l.default.has(this.dataTables,e))throw new Error("DataManager: Data table with name '"+e+"' does not exists");for(var t=l.default.keys(this.dataTables[e]),n=[],a=0;a<t.length;a++)n.push(t[a]);return n}},{key:"toJSON",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(e){if(!l.default.has(this.dataTables,e))throw new Error("DataManager: Data table with name '"+e+"' does not exists");JSON.stringify(this.dataTables[e])}else JSON.stringify(this.dataTables)}},{key:"saveData",value:function(){try{}catch(e){(0,u.debugError)(e)}}},{key:"globalLog",get:function(){return this._globalLog},set:function(e){}},{key:"nextLogId",get:function(){return this.globalLog.id.length>0?l.default.max(this.globalLog.id)+1:0},set:function(e){if(e.constructor!==u.String)throw new Error("DataManager: id should be a string.");this._customNextID=e,console.log("DataManager: next event 'id' will be "+e)}}]),t}();t.default=d},function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),s=n(13),l=a(s),u=n(0),d=function(){function e(){i(this,e),this.defaultLanguage="en",this.currentLanguage=this.defaultLanguage,this.data={},this.overwrite=!0,this.useAjax=!0;for(var t=arguments.length,n=Array(t),a=0;a<t;a++)n[a]=arguments[a];this.addFiles(n)}return o(e,[{key:"addFiles",value:function(){var e;if(this.useAjax===!1)throw new Error("RessourceManager.addFiles: useAjax set to false - can't add files over the network");var t=(e=[]).concat.apply(e,arguments);this.files=[];for(var n=[],a=0;a<t.length;a++)this.isOfValidFormat(t[a])?(this.files[a]={},this.files[a].type=this.getFormat(t[a]),this.files[a].path=t[a],this.files[a].loaded=!1,this.files[a].validated=!1,this.files[a].added=!1,this.files[a].raw=!1,this.files[a].data=null,n.push(this.loadFile(a))):console.warn("RessourceManager.addFiles: invalid type for "+t[a]);return Promise.all(n)}},{key:"loadFile",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,u.mandatory)(),t=new u.Deferred;if(void 0===this.files[e])return t.reject("RessourceManager.loadFile: files[fileIndex] is not defined");var n=this;return l.default.ajax({type:"GET",url:this.files[e].path}).then(function(a){n.files[e].loaded=!0,n.files[e].raw=a;try{n.parseRaw(e)}catch(e){t.reject(e)}finally{t.resolve("RessourceManager.loadFile: "+n.files[e].path+" parsed")}}),t.promise}},{key:"parseRaw",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,u.mandatory)();if(void 0===this.files[e])throw new Error("RessourceManager.parseRaw: files[fileIndex] is not defined");var t=this.files[e];if(null===t.raw)throw new Error("RessourceManager.parseRaw: file.raw is null or not validated");var n=void 0,a=null;switch(t.type){case"json":n=JSON.parse;break;case"csv":n=l.default.csv.toObjects;break;case"xml":window.DOMParser?(n=new DOMParser,n=n.parseFromString,a="text/xml"):(n=new window.ActiveXObject("Microsoft.XMLDOM"),n.async=!1,n=n.loadXML);break;default:throw new Error("RessourceManager.parseRaw: file.type is null or not validated")}try{t.data=a?n(t.raw,a):n(t.raw)}catch(e){throw t.validated=!1,t.data=null,new Error(e)}finally{t.validated=!0,this.processParsed()}}},{key:"processParsed",value:function(){for(var e=0;e<this.files.length;e++)if(this.files[e].validated!==!1&&this.files[e].data&&!this.files[e].added){for(var t=this.files[e].data,n=Object.keys(t),a=0;a<n.length;a++)this.addDataFamilly(n[a],t[n[a]]);this.files[e].added=!0}}},{key:"addDataFamilly",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,u.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,u.mandatory)(),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=t,i=void 0;t.constructor!==Object&&(i=e,e=t.constructor.name.toLowerCase()+"s",a=r({},i,t)),void 0===this.data[e]&&(this.data[e]={}),null===n&&(n=this.overwrite),this.data[e]=n?this.extend(this.data[e],a):this.extend(a,this.data[e])}},{key:"getNextId",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,u.mandatory)();return this.data.hasOwnProperty(e)?Object.keys(this.data[e]).length:0}},{key:"add",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,u.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(e.constructor!==Object)throw new Error("RessourceManager.add: cannot add data from a non object");var n=this.overwrite;null===t?t=n:this.overwrite=t;for(var a=Object.keys(e),r=0;r<a.length;r++)e[a[r]].constructor===Object?this.addDataFamilly(a[r],e[a[r]]):e[a[r]].constructor===Array?this.addByName(a[r],e[a[r]],"arrays"):this.addByName(a[r],e[a[r]]);this.overwrite=n}},{key:"addByName",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,u.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,u.mandatory)(),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"strings",a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;void 0===this.data[n]&&(this.data[n]={}),null===a&&(a=this.overwrite),this.data[n].hasOwnProperty(e)&&!a||(console.warn("RessourceManager.addByName: already a ressource named "+e+" - Overwriting it."),this.data[n][e]=t)}},{key:"getFormat",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,u.mandatory)();return e.substr(2+(~-e.lastIndexOf(".")>>>0))}},{key:"isOfValidFormat",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,u.mandatory)();return["json","csv","xml"].indexOf(this.getFormat(e))!==-1}},{key:"mergeWith",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,u.mandatory)();if(t.constructor!==e)throw new Error("RessourceManager.mergeWith: specified ressourceManager is not of class RessourceManager.");for(var n=this.famillies,a=t.famillies,r=0;r<a.length;r++)n.indexOf(a[r])===-1?this.data[a[r]]=t.data[a[r]]:this.data[a[r]]=this.extend(this.data[a[r]],t.data[a[r]])}},{key:"lookFor",value:function(){for(var e=void 0,t=arguments.length,n=Array(t),a=0;a<t;a++)n[a]=arguments[a];if(1===n.length){if(this.data.hasOwnProperty(n))e=this.data[n];else for(var r=this.famillies,i=0;i<r.length;i++)if(this.data[r[i]].hasOwnProperty(n)){e=this.data[r[i]][n];break}}else if(n.length>1){e={};for(var o=0;o<n.length;o++)e[n[o]]=this.lookFor(n[o])}return e}},{key:"extend",value:function(){var e={},t=!1,n=0,a=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments.length<=0?void 0:arguments[0])&&(t=arguments.length<=0?void 0:arguments[0],n+=1);for(var r=function(n){for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(t&&"[object Object]"===Object.prototype.toString.call(n[a])?e[a]=this.extend(!0,e[a],n[a]):e[a]=n[a])};n<a;n++){r(arguments.length<=n?void 0:arguments[n])}return e}},{key:"famillies",get:function(){return Object.keys(this.data)}},{key:"has",get:function(){return new Proxy(this,{get:function(e,t){return void 0!==e.get[t]}})}},{key:"get",get:function(){return new Proxy(this,{get:function(e,t){for(var n=t.split("_"),a=e.famillies,r=e.currentLanguage,i="strings",o=void 0,s=!1,l=0;l<n.length;l++)if(a.indexOf(n[l])!==-1)i=n[l],s=!0;else if(2===n[l].length)r=n[l];else{if(void 0!==o)return void console.error("RessourceManager.get: at least two possible variable names into path: "+o+" and "+n[l]);o=n[l]}if(void 0===o){if(!s)return void(0,u.debugError)("RessourceManager.get: no variable name found in "+t);o=i}var d=void 0;if(e.data.hasOwnProperty(i)&&e.data[i].hasOwnProperty(o))d=e.data[i][o];else if(void 0===(d=e.lookFor(o)))return void console.error("RessourceManager.get: no ressource for path "+i+"."+o);return d.constructor!==Object?d:d.hasOwnProperty(r)?d[r]:d.hasOwnProperty(e.currentLanguage)?(console.warn("RessourceManager.get: no valid language, defaulting to "+e.currentLanguage),d[e.currentLanguage]):(console.warn("RessourceManager.get: no localization language found, returning the whole object"),d)}})}}]),e}();t.default=d},function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),o=n(1),s=a(o),l=n(2),u=a(l),d=n(0),c=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,d.mandatory)(),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,d.mandatory)();r(this,e),this._stateManager=t,this._parent=t._parent,this._dataManager=t._dataManager,this.stateKey=n,this._eventFunctions={},this._awakeningFunctions=[],this._endingFunctions=[],this._updateFunctions=[],this._frozenEvents=[],this._frozenAt=null,this.FREEZE_DELAY=50}return i(e,[{key:"awake",value:function(){if(null!==this._frozenAt)this.unfreeze();else{void 0!==this._parent.sceneKey&&(0,d.debuglog)(this.stateKey+" of scene "+this._parent.sceneKey+" awaken.");for(var e=[],t=0;t<this._awakeningFunctions.length;t++)e[t]=Promise.method(this._awakeningFunctions[t].bind(this.context));Promise.all(e).then(function(){(0,d.debuglog)("State: Awakening functions completed as expected.",e)}).catch(function(e){(0,d.debugError)(e)})}}},{key:"end",value:function(){for(var e=this,t=[],n=0;n<this._endingFunctions.length;n++)t[n]=Promise.method(this._endingFunctions[n].bind(this.context));Promise.all(t).then(function(n){return(0,d.debuglog)("State: Ending functions completed as expected.",t),(0,d.debuglog)(e.stateKey+" ended."),n}).catch(function(e){return(0,d.debugError)(e),null})}},{key:"update",value:function(){if(null===this._frozenAt)for(var e=void 0;this._stateManager.eventHeap.length;)e=this._stateManager.getFirstEventAndRemoveFromHeap(),(0,d.debuglog)("State: first event is "+e.flag),this.handleEvent(e)}},{key:"handleEvent",value:function(e){if(this.hasEventFunction(e.flag)){var t=this._eventFunctions[e.flag];if(t.constructor===Array)for(var n=0;n<t.length;n++)Promise.method(t[n].bind(this.context))(e).then(function(t,n){(0,d.debuglog)(n);var a=s.default.cloneDeep(e);a.data.handlingFunction=t,this._stateManager.stateHasFinishedHandlingEvent(a)}.bind(this,t[n].name)).catch(function(e){(0,d.debugError)(e)});else Promise.method(t.bind(this.context)).then(function(t,n){(0,d.debuglog)(n);var a=s.default.cloneDeep(e);a.data.handlingFunction=t,this._stateManager.stateHasFinishedHandlingEvent(a)}.bind(this,t.name)).catch(function(e){(0,d.debugError)(e)})}else this._stateManager.stateHasFinishedHandlingEvent(e),(0,d.debuglog)("State: Event '"+e.flag+"' not handled by state '"+this.stateKey+"'")}},{key:"freeze",value:function(){var e=this._stateManager;this._frozenAt=e.timeInMs,this._frozenEvents=e.getAllEvents(),(0,d.debugWarn)(this._frozenEvents),e.stateWasFrozen(this.stateKey)}},{key:"unfreeze",value:function(){if(null===this._frozenAt)return void(0,d.debugWarn)("State.unfreeze: state was not frozen");for(var e=this._stateManager,t=this._frozenEvents,n=0;n<t.length;n++)t[n].constructor===u.default&&(t[n].happenedAt+=e.timeInMs-this._frozenAt,t[n].happenedAt-e.timeInMs>this.FREEZE_DELAY?(e.addTimeTriggerEvent(t[n]),console.log("timetrigger"),(0,d.debugWarn)(t[n])):(e.addEvent(t[n]),console.log("added event"),(0,d.debugWarn)(t[n])));this._frozenAt=null,this._frozenEvents=[],e.stateWasUnfreezed(this.stateKey)}},{key:"registerEventFunctions",value:function(e,t){for(var n=arguments.length,a=Array(n>2?n-2:0),r=2;r<n;r++)a[r-2]=arguments[r];d.mustBeDefined.apply(void 0,[e,t].concat(a)),d.mustHaveConstructor.apply(void 0,[Function].concat(a)),this.hasEventFunction(e)?this._eventFunctions[e].constructor===Array?(this._eventFunctions[e]=this._eventFunctions[e].concat(a),(0,d.debuglog)("State "+this.stateKey+": several handling functions - handling function pushed to the array of event functions on event '"+e+"'")):(this._eventFunctions[e]=[this._eventFunctions[e]].concat(a),(0,d.debuglog)("State "+this.stateKey+": several handling functions - array created for handling functions for state on event '"+e+"'")):(this._eventFunctions[e]=a,(0,d.debuglog)("State "+this.stateKey+": handling function added to state '"+this.stateKey+"' for event '"+e+"'"))}},{key:"registerCycleFunctions",value:function(e,t){for(var n=arguments.length,a=Array(n>2?n-2:0),r=2;r<n;r++)a[r-2]=arguments[r];d.mustBeDefined.apply(void 0,[e,t].concat(a)),d.mustHaveConstructor.apply(void 0,[Function].concat(a));var i=void 0;switch(e){case"awakening":i="_awakeningFunctions";break;case"ending":i="_endingFunctions";break;case"update":i="_updateFunctions";break;default:throw new Error("State.registerCycleFunctions: Invalid cycle parameter.")}t?(this[i]=a,(0,d.debuglog)("State "+this.stateKey+": handling function overwrited "+i)):(this[i]=this[i].concat(a),(0,d.debuglog)("State "+this.stateKey+": handling function added to "+i+" array for state '"+this.stateKey+"'"))}},{key:"addHandledEvents",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];d.mustBeDefined.apply(void 0,t),d.mustHaveConstructor.apply(void 0,[Function].concat(t));for(var a=0;a<t.length;a++)this.registerEventFunctions(t[a].name,!0,t[a])}},{key:"addEventFunctions",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];d.mustBeDefined.apply(void 0,[e].concat(n)),d.mustHaveConstructor.apply(void 0,[Function].concat(n)),this.registerEventFunctions.apply(this,[e,!1].concat(n))}},{key:"overwriteEventFunctions",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];d.mustBeDefined.apply(void 0,[e].concat(n)),d.mustHaveConstructor.apply(void 0,[Function].concat(n)),this.registerEventFunctions.apply(this,[e,!0].concat(n))}},{key:"addAwakeningFunctions",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];d.mustBeDefined.apply(void 0,t),d.mustHaveConstructor.apply(void 0,[Function].concat(t)),this.registerCycleFunctions.apply(this,["awakening",!1].concat(t))}},{key:"overwriteAwakeningFunctions",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];d.mustBeDefined.apply(void 0,t),d.mustHaveConstructor.apply(void 0,[Function].concat(t)),this.registerCycleFunctions.apply(this,["awakening",!0].concat(t))}},{key:"overwriteEndingFunction",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];d.mustBeDefined.apply(void 0,t),d.mustHaveConstructor.apply(void 0,[Function].concat(t)),this.registerCycleFunctions.apply(this,["ending",!0].concat(t))}},{key:"addEndingFunctions",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];d.mustBeDefined.apply(void 0,t),d.mustHaveConstructor.apply(void 0,[Function].concat(t)),this.registerCycleFunctions.apply(this,["ending",!1].concat(t))}},{key:"overwriteUpdateFunctions",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];d.mustBeDefined.apply(void 0,t),d.mustHaveConstructor.apply(void 0,[Function].concat(t)),this.registerCycleFunctions.apply(this,["udpate",!1].concat(t))}},{key:"addUpdateFunctions",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];d.mustBeDefined.apply(void 0,t),d.mustHaveConstructor.apply(void 0,[Function].concat(t)),this.registerCycleFunctions.apply(this,["udpate",!1].concat(t))}},{key:"hasEventFunction",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,d.mandatory)();return s.default.has(this._eventFunctions,e)}},{key:"getGlobal",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,d.mandatory)();return this._stateManager.getGlobal(e)}},{key:"setGlobal",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,d.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,d.mandatory)();return this._stateManager.setGlobal(e,t)}},{key:"context",get:function(){return this._stateManager._taskObject?this._stateManager._taskObject.getContext(this):{taskObject:null,dataManager:this._stateManager._dataManager,scene:this._parent,stateManager:this._stateManager,state:this,R:this._stateManager.R}}}]),e}();t.default=c},function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}function r(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),s=n(1),l=a(s),u=n(8),d=n(4),c=a(d),h=n(5),g=a(h),f=n(3),v=a(f),y=n(2),m=a(y),p=n(0),b=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)("parent"),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;i(this,e),this._parent=t,this._dataManager=n,void 0!==t.parentTaskObject?(this._taskObject=t.parentTaskObject,this.R=this._taskObject.R):this.R=new c.default;var a=this.R;this._eventHeap=[],this._timeTriggerEvents=[],this.errorLog=[],this.R.add({states:{idle:"idle",pause:"pause",active:"active"},values:{timestampThreshold:1e8}},!1),this.states={idle:new g.default(this,a.get.states_idle),active:new g.default(this,a.get.states_active),pause:new g.default(this,a.get.states_pause)},this._currentStateKey=a.get.states_idle,this.frozenState=null,this.globals={},this.globalFunctions={}}return o(e,[{key:"update",value:function(){for(var e=0;e<this._timeTriggerEvents.length;e++)this.timeInMs>=this._timeTriggerEvents[e].happenedAt&&(this._timeTriggerEvents[e].happenedAt=this.timeInMs,this.addEvent(this._timeTriggerEvents[e]),this._timeTriggerEvents.splice(e));this.currentState.update()}},{key:"storeEvent",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)();if(this._dataManager.constructor!==v.default)throw new Error("storeEvent: dataManager is not set, cannot store event.");if(!e.handled)throw(0,p.debuglog)(e),new Error("StateManager: cannot store an event that was not handled.");if(e.stored)throw(0,p.debuglog)(e),new Error("StateManager: Event already stored");e.storedInErrorLog=!1;for(var t=0;t<e.data.belongsTo.length;t++)try{e.data.storedAt=this.timeInMs,e.stored=!0,this._dataManager.addRows(e.data.belongsTo[t],e),(0,p.debuglog)("StateManager: storing event."),(0,p.debuglog)(e)}catch(n){console.log("StateManager: Could not store data in "+e.data.belongsTo[t]+" dataTable. Data was stored in the errorLog. DataManager error was: "+n),this.storeInErrorLog(e)}}},{key:"storeData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)();if(this._dataManager.constructor!==v.default)throw new Error("StateManager.storeData: dataManager is not set, cannot store event.");if(!l.default.has(e,"belongsTo"))throw(0,p.debuglog)(e),new Error("StateManager: data needs a belongsTo property in order to store it in the dataManager.");e.storedInErrorLog=!1;for(var t=0;t<e.belongsTo.length;t++)try{this._dataManager.addRows(e.belongsTo[t],e)}catch(n){console.error("StateManager: Could not store data in "+e.belongsTo[t]+" dataTable. Data was stored in the errorLog. DataManager error was: "+n),this.storeInErrorLog(e)}}},{key:"storeInErrorLog",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)();e.storedInErrorLog===!1?(e.storedInErrorLog=!0,this.errorLog=this.errorLog.concat(e),(0,p.debuglog)("StateManager: data stored in the errorLog.")):(0,p.debugWarn)("StateManager: data already stored in errorLog. Did not store it again.")}},{key:"addState",value:function(){for(var e=[],t=void 0,n=arguments.length,a=Array(n),r=0;r<n;r++)a[r]=arguments[r];for(var i=0;i<a.length;i++){if(t=a[i],t.constructor!==String)throw new Error("StateManager: stateKey must be a string.");if(l.default.has(this.states,t))throw new Error("StateManager: a state with a similar stateKey '"+t+"' already exists.");this.states[t]=new g.default(this,t),(0,p.debuglog)("StateManager: added state '"+t+"'."),e.push(this.states[t])}return 1===e.length?e[0]:e}},{key:"goToState",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)();if(!l.default.has(this.states,e))throw new Error("StateManager: Invalid state key.");this.currentState.end(),this._currentStateKey=e,this.states[e].awake()}},{key:"setPauseKeyStroke",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:32,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(void 0===this.state)throw new Error("state.pauseState: state is undefined");var n=this.state,a=this.stateManager,r=this.R;return t.data.keyCode===e&&(n.freeze(),a.goToState(r.get.states_pause)),"state.pauseState: resolved"},r=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(void 0===this.stateManager)throw new Error("state.unPause: state is undefined");if(t.data.keyCode===e){if(null===this.stateManager.frozenState)throw new Error("state.unPause: no frozen state !");this.stateManager.goToState(this.stateManager.frozenState)}return"state.unPause: resolved"};t=null!==t?t:this.R.get.events.keydown;for(var i=this.stateKeys,o=0;o<i.length;o++)i[o]!==this.R.get.states_pause?this.registerEventFunction(i[o],t,a):this.registerEventFunction(i[o],t,r);n&&this.addDefaultPauseDesign()}},{key:"addDefaultPauseDesign",value:function(){if(null===u.BABYLON)return!1;var e=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(void 0===this.taskObject)throw new Error("state.awakePause: taskObject is undefined");var t=this.stateManager,n=t.get("pauseBackground2D"),a=t.get("elements2D"),r=a.canvas;if(null!==n)n.opacity=1;else{var i={id:"pauseBackground2D",text:"Pause",x:0,y:0,width:r.width,height:r.height,fill:u.BABYLON.Canvas2D.GetSolidColorBrush(new u.BABYLON.Color4(.3,.3,.3,.5)),fontName:"60pt Verdana"};e=l.default.extend(i,e),n=new u.BABYLON.Rectangle2D({parent:r,id:e.id,x:e.x,y:e.y,width:e.width,height:e.height,fill:e.fill,roundRadius:0,children:[new u.BABYLON.Text2D(e.text,{fontName:e.fontName,marginVAlignment:"v: top",marginHAlignment:3})]}),t.set("pauseBackground2D",n)}return"state.awakePause: resolved"},t=function(){if(void 0===this.state)throw new Error("state.endPause: state is undefined");var e=this.stateManager,t=e.get("pauseBackground2D");return null!==t&&(t.dispose(),e.set("pauseBackground2D",null)),"state.endPause: resolved"};return this.registerAwakeningFunction(this.R.get.states_pause,e),this.registerEndingFunction(this.R.get.states_pause,t),!0}},{key:"stateWasFrozen",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)();this.frozenState=e,this.emptyEventHeap(),this.emptyTimeTriggerEvents()}},{key:"stateWasUnfreezed",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)();if(this.frozenState!==e)throw new Error("StateManager.stateWasUnfreezed: stateKey does not correspond to the frozenState");this.frozenState=null}},{key:"addTimeTriggerEvent",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)("event");e.constructor===m.default?e.happenedAt>this.timeInMs+40?(this._timeTriggerEvents.push(e),(0,p.debuglog)("StateManager: Trigger event added to the time triggers.")):(this.addEvent(e),(0,p.debugError)("StateManager.addTimeTriggerEvent: trigger event is to close to current time (<40ms). Added directly to the heap.")):(0,p.debugError)("StateManager: Event is not of class EventData.")}},{key:"addEvent",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)("event");e.constructor===m.default?(this._eventHeap.push(e),(0,p.debuglog)("StateManager: Event added to the heap.")):(0,p.debugError)("StateManager: Event is not of class EventData.")}},{key:"newEvent",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:["globalLog"];if(e.constructor===m.default)return(0,p.debuglog)("StateManager.newEvent: flag is an EventData object. Using addEvent()."),this.addEvent(e),e;if(a.constructor!==Array){if(a.constructor!==String)throw new Error("stateManager.newEvent: belongs to need to be either a string or an array");a=[a]}else a.indexOf("globalLog")===-1&&a.push("globalLog");var r={belongsTo:a,handledAt:null,storedAt:null};if(null!==n&&(r.data=n),null===t){(0,p.debuglog)("stateManager.newEvent: time is null, using addEvent() with this.timeInMs.");var i=new m.default(e,this.timeInMs,r);return this.addEvent(i),i}t<this.R.get.values_timestampThreshold&&(t+=this.timeInMs);var o=new m.default(e,t,r);return this.addTimeTriggerEvent(o),o}},{key:"removeFirstEvent",value:function(){this._eventHeap.splice(0,1)}},{key:"removeEvent",value:function(e){this._eventHeap=l.default.without(this._eventHeap,e)}},{key:"getFirstEventAndRemoveFromHeap",value:function(){var e=this.firstEvent;return this.removeFirstEvent(),e}},{key:"emptyEventHeap",value:function(){this._eventHeap=[]}},{key:"emptyTimeTriggerEvents",value:function(){this._timeTriggerEvents=[]}},{key:"getAllEvents",value:function(){return this._eventHeap.concat(this._timeTriggerEvents)}},{key:"stateHasFinishedHandlingEvent",value:function(e){e.data.handledAt=this.timeInMs,e.handled=!0,(0,p.debuglog)("StateManager.stateHasFinishedHandlingEvent: event was handled."),(0,p.debuglog)(e),this._dataManager.constructor===v.default?this.storeEvent(e):(0,p.debugWarn)("StateManager.stateHasFinishedHandlingEvent: dataManager is not set, not storing event.")}},{key:"freezeEventHeap",value:function(){this.eventHeapIsFrozen=!0,this.frozenEventHeap=this._eventHeap}},{key:"unfreezeEventHeap",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.eventHeapIsFrozen=!1,e&&this.emptyEventHeap()}},{key:"registerEventFunction",value:function(e,t){for(var n=arguments.length,a=Array(n>2?n-2:0),r=2;r<n;r++)a[r-2]=arguments[r];if(p.mustBeDefined.apply(void 0,[e,t].concat(a)),p.mustHaveConstructor.apply(void 0,[Function].concat(a)),!l.default.has(this.states,e))throw new Error("StateManager: Invalid state key '"+e+"'. Create the state before adding event handling functions.");var i;(i=this.states[e]).registerEventFunctions.apply(i,[t,!0].concat(a))}},{key:"registerAwakeningFunction",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,p.mandatory)(),n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!l.default.has(this.states,e))throw new Error("StateManager: Invalid state key '"+e+"'. Create the state before adding awakening handling functions.");this.states[e].registerCycleFunctions("awakening",n,t)}},{key:"registerEndingFunction",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,p.mandatory)(),n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!l.default.has(this.states,e))throw new Error("StateManager: Invalid state key '"+e+"'. Create the state before adding awakening handling functions.");this.states[e].registerCycleFunctions("ending",n,t)}},{key:"registerUpdateFunction",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,p.mandatory)(),n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!l.default.has(this.states,e))throw new Error("StateManager: Invalid state key '"+e+"'. Create the state before adding awakening handling functions.");this.states[e].registerCycleFunctions("udpate",n,t),(0,p.debuglog)("StateManager: handling function added to awakeningFunctions array for state '"+e+"'")}},{key:"registerGlobalFunction",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(e.constructor!==Function)throw new Error("StateManager.registerGlobalFunction: func is not a function");null===t&&(t=e.name),this.globalFunctions[t]=e}},{key:"register",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var a=0;a<t.length;a++)this.registerGlobalFunction(t[a])}},{key:"callGlobalFunction",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];this.call.apply(this,[e].concat(n))}},{key:"call",value:function(e){if((0,p.mustBeDefined)(e),void 0===e)throw new Error("StateManager.call: name of the function needs to be defined.");if(l.default.has(this.globalFunctions,e)){for(var t=arguments.length,n=Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];return this.globalFunctions[e].bind(this.context).apply(void 0,n)}(0,p.debugWarn)("StateManager.call: globals do not contain function '"+e+"'")}},{key:"promise",value:function(e){if((0,p.mustBeDefined)(e),void 0===e)throw new Error("StateManager.promiseGlobalFunction: name is undefined.");if(l.default.has(this.globalFunctions,e)){for(var t=arguments.length,n=Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];return Promise.method(this.globalFunctions[e]).bind(this.context).apply(void 0,n)}(0,p.debugWarn)("StateManager.promiseGlobalFunction: globals do not contain function '"+e+"'")}},{key:"recurseOnGlobalFunction",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,p.mandatory)(),n=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];if(!l.default.has(this.globalFunctions,e))throw new Error("StateManager.recurseOnGlobalFunction: globals do not contain function '"+e+"'");return 0===t?new Promise(function(e){e(i)}):this.promise.apply(this,[e].concat(r(a))).then(function(r){return i=i.concat(r),n.recurseOnGlobalFunction(e,t-1,a,i)})}},{key:"recurse",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,p.mandatory)(),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];this.recurseOnGlobalFunction(e,t,n,a)}},{key:"getGlobal",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)();return l.default.has(this.globals,e)?this.globals[e]:((0,p.debugWarn)("StateManager: globals do not contain variable '"+e+"'"),null)}},{key:"get",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)();return this.getGlobal(e)}},{key:"setGlobal",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,p.mandatory)();this.globals[e]=t,(0,p.debuglog)("StateManager: global '"+e+"' set to '"+t+"'")}},{key:"set",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,p.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,p.mandatory)();this.setGlobal(e,t)}},{key:"getStateObject",value:function(e){if(l.default.has(this.states,e))return this.states[e];throw new Error("StateManager: Invalid state key.")}},{key:"context",get:function(){return this._taskObject?this._taskObject.getContext(this):{taskObject:null,dataManager:this._dataManager,scene:this._parent,stateManager:this,state:this.currentState,R:this.R}}},{key:"stateKeys",get:function(){return Object.keys(this.states)}},{key:"currentStateKey",get:function(){return this._currentStateKey},set:function(e){if(!l.default.has(this.states,e))throw new Error("StateManager: Invalid state key.");this.goToState(e)}},{key:"currentState",get:function(){return this.states[this.currentStateKey]},set:function(e){if(void 0===e.key)throw new Error("StateManager: Invalid state, it has no state key defined.");this.currentStateKey=e.key}},{key:"eventHeap",get:function(){return this._eventHeap},set:function(e){throw new Error("StateManager: eventHeap is readonly. Add events through the class methods.")}},{key:"firstEvent",get:function(){if(this._eventHeap.length)return this._eventHeap[0]},set:function(e){throw new Error("StateManager: firstEvent is readonly.")}},{key:"time",get:function(){return this.timeInMs}},{key:"timeInSec",get:function(){return(new Date).getTime()/1e3}},{key:"timeInMs",get:function(){return(new Date).getTime()}}]),e}();t.default=b},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DEBUG_MODE_ON=!0},function(e,n){e.exports=t},function(e,t,n){"use strict";(function(e){function a(e){return e&&e.__esModule?e:{default:e}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),s=n(1),l=a(s),u=n(8),d=n(11),c=n(3),h=a(c),g=n(4),f=a(g),v=n(2),y=a(v),m=n(6),p=a(m),b=n(5),w=a(b),k=n(0),M=n(7);if("undefined"!=typeof window){var E=document.getElementsByTagName("script");if(E.length){var S=E[E.length-1].src,O=S.indicesOf("/");window.assetsFolderFullpath=S.substr(0,O[O.length-2])}else window.assetsFolderFullpath="./"}var _=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,k.mandatory)(),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,a=(arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]?arguments[3]:"babylon");if(i(this,t),"undefined"!=typeof window)return{error:"Wrong environment. ExperimentJS only works in the browser."};if(this._target=e,this.canvas=e.get(0),"babylon"!==a)throw new Error("TaskObject.constructor: engine not supported.");this.engine=new u.BABYLON.Engine(this.canvas,!1,null,!1),this.height=window.innerHeight,this.width=window.innerWidth,this.babylonCanvasHeight=this.canvas.height,this.babylonCanvasWidth=this.canvas.width,this.dataManager=new h.default(this);var r=["id","flag","happenedAt","data"];this.dataManager.addTable("keyEvents",r),this.dataManager.addTable("mouseEvents",r);var o=["level","happenedAt"];this.dataManager.addTable("taskStatus",o);var s=["flag","happenedAt"];this.dataManager.addTable("statusFlags",s),this.ASSETS_FOLDER=n?n:window.assetsFolderFullpath,this.ASSETS_FLARE_PATH=this.ASSETS_FOLDER+"/textures/flare/flare.png",this.R=new f.default,this.R.add({states:{active:"active",idle:"idle",pause:"pause"},folders:{assetsFolder:n||window.assetsFolderFullpath}}),this.flags={},this.keyState=[],this.shouldShowDebug=void 0!==M.DEBUG_MODE_ON&&M.DEBUG_MODE_ON,this.setupGlobalEvents(),this._currentModal=this.MODAL_INTRODUCTION,this.parameters={},this.variables={},this.variables.shouldSeeInformation=!0,this.scenes={},this.sceneGenerators={},this.sceneGenerators.functions={},this.sceneGenerators.functionsOptions={},this._currentSceneKey="",this._paramBox=null,"function"==typeof d.ParamBox&&(this._paramBox=new d.ParamBox)}return o(t,[{key:"registerSceneGenerator",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,k.mandatory)("sceneGenerator"),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=(arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]?arguments[4]:null);t=l.default.clone(t),a=null===a&&""!==e.name?e.name:"scene"+Object.keys(this.sceneGenerators.functions).length,n?(this.sceneGenerators.loading=e,this.sceneGenerators.loadingOptions=t):(this.sceneGenerators.functions[a]=e,this.sceneGenerators.functionsOptions[a]=t)}},{key:"registerLoadingFunction",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,k.mandatory)("loadingSceneGenerator"),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];t.sceneKey="loading",this.registerSceneGenerator(e,t,!0,n)}},{key:"callSceneGenerator",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,k.mandatory)(),n=this.sceneGenerators.functionsOptions[t],a=this.sceneGenerators.functions[t];return Promise.method(a.bind(this.context))(n).then(function(n){void 0===n.sceneKey&&(n.sceneKey=t),e.scenes[n.sceneKey]=n})}},{key:"generateScenes",value:function(){for(var e=Object.keys(this.sceneGenerators.functions),t=[],n=0;n<e.length;n++)t.push(this.callSceneGenerator(e[n]));return Promise.all(t)}},{key:"cloneAssetsIntoScene",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,k.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,k.mandatory)();e.constructor!==k.Array&&(e=[e]);for(var n=[],a=0;a<e.length;a++){var r=e[a].clone();if(r._scene=t,e[a].constructor===u.BABYLON.Mesh){if(r.material&&(r.material=r.material.clone(),r.material._scene=t,r.material.subMaterials))for(var i=0;i<r.material.subMaterials.length;i++)r.material.subMaterials[i]=r.material.subMaterials[i].clone(),r.material.subMaterials[i]._scene=t;t.addMesh(r)}n.push(r)}return n}},{key:"loadAssets",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,k.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,k.mandatory)(),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";if(e.constructor!==Object)throw new Error("TaskObject.loadAssets: assetObject is not an Object");""===n&&void 0!==this.ASSETS_FOLDER&&(n=this.ASSETS_FOLDER);for(var a=["png","bmp","jpg","tiff"],i=new u.BABYLON.AssetsManager(t),o=this.R,s=Object.keys(e),l=void 0,d=void 0,c=void 0,h=0;h<s.length;h++)if(l=e[s[h]],l.constructor===k.String?(c=this.ASSETS_FOLDER+l,a.indexOf(o.getFormat(c))!==-1?d="texture":(console.warn("TaskObject.loadAssets: asset invalid or not implement with shorthand function"),d="invalid")):l.constructor===Object&&Object.keys(l).includes(["path","type"])?(c=this.ASSETS_FOLDER+l.path,d=l.type):(console.warn("TaskObject.loadAssets: asset invalid or not implement with shorthand function"),d="invalid"),"texture"===d){var g=i.addTextureTask(s[h]+"Task",c);g.onSuccess=function(e){o.add({textures:r({},this.textureName,e.texture)})}.bind({textureName:s[h]})}var f=new k.Deferred;return i.load(),i.onFinish=function(e){(0,k.debuglog)("TaskObject.loadAssets: tasks completed",e),f.resolve(t)},f.promise}},{key:"cloneAssetIntoScene",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,k.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,k.mandatory)();if(e.constructor===k.Array)return this.cloneAssetsIntoScene(e,t);var n=e.clone();if(n._scene=t,e.constructor===u.BABYLON.Mesh){if(n.material&&(n.material=n.material.clone(),n.material._scene=t,n.material.subMaterials))for(var a=0;a<n.material.subMaterials.length;a++)n.material.subMaterials[a]=n.material.subMaterials[a].clone(),n.material.subMaterials[a]._scene=t;t.addMesh(n)}return n}},{key:"startTask",value:function(){var t=this;if("undefined"==typeof window||void 0!==e)return Promise.resolve();window.addEventListener("resize",function(){t.engine.resize()});var n=new k.Deferred,a=this.sceneGenerators.loadingOptions,r=this.sceneGenerators.loading.bind(this.context)(a);return r.loadingPromise.then(function(){return t.scenes.loading=r,t.currentScene=r.sceneKey,void 0!==r.loadingPromise&&r.loadingPromise.constructor===Promise?r.loadingPromise:Promise.resolve()}).then(function(){return t.dataManager.addRows("statusFlags",{flag:t.R.get.flags_hasLoaded,happenedAt:t.timeInMs}),t.engine.runRenderLoop(function(){t.scenes[t.currentScene].render()}),t.generateScenes()}).then(function(e){(0,k.debuglog)(e),n.resolve("TaskObject.startTask: loaded and scene generated.")}),n.promise}},{key:"setupGlobalEvents",value:function(){var e=this,t=this.R;t.add({flags:{hasLoaded:"hasLoaded",sceneStarts:"scene_starts",sceneEnds:"scene_ends"},events:{mouseMove:"mouse_move",click:"mouse_click",pick:"mouse_pick",keydown:"key_down",keyup:"key_up",resize:"resize",pause:"pause",wasHandled:"was_handled",beingHandled:"being_handled"}}),window.addEventListener("keydown",function(n){(0,k.debuglog)("TaskObject: Keydown event."),(0,k.debuglog)(n),e.keyfunction(n);var a=new y.default(t.get.events_keydown,e.timeInMs,{belongsTo:["globalLog","keyEvents"],handledAt:null,storedAt:null,keyCode:n.keyCode});void 0!==e.currentSceneObject&&void 0!==e.currentSceneObject.stateManager&&e.currentSceneObject.stateManager.addEvent(a)}),window.addEventListener("keyup",function(t){e.keyfunction(t)}),window.addEventListener("mousedown",function(n){(0,k.debuglog)("TaskObject: mousedown event."),(0,k.debuglog)(n);var a=new y.default(t.get.events_click,(new Date).getTime(),{belongsTo:["globalLog","mouseEvents"],handledAt:null,storedAt:null,clientX:n.clientX,clientY:n.clientY,engineX:n.clientX*(e.renderSize.width/window.innerWidth),engineY:(window.innerHeight-n.clientY)*(e.renderSize.height/window.innerHeight)});void 0!==e.currentSceneObject&&void 0!==e.currentSceneObject.stateManager&&e.currentSceneObject.stateManager.addEvent(a)}),window.addEventListener("resize",function(n){(0,k.debuglog)("TaskObject: resize event."),(0,k.debuglog)(n);var a=new y.default(t.get.events_resize,e.timeInMs,{belongsTo:["globalLog"],handledAt:null,storedAt:null,outerHeight:n.target.outerHeight,outerWidth:n.target.outerWidth});if(void 0!==e.currentSceneObject)try{e.addEventToCurrentScene(a)}catch(e){console.error(e)}finally{void 0!==e.currentSceneObject.updateContentFrame&&e.currentSceneObject.updateContentFrame()}})}},{key:"keyfunction",value:function(e){var t=68,n=18;this.keyState[e.keyCode]="keydown"===e.type,this.keyState[16]&&this.keyState[n]&&this.keyState[t]&&(this.keyState[t]=!1,this.keyState[n]=!1,this.toggleDebugLayer(),e.preventDefault())}},{key:"addStateManager",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,k.mandatory)("scene");e.stateManager=new p.default(e,this.dataManager)}},{key:"addEventToCurrentScene",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,k.mandatory)();if(void 0===this.currentSceneObject)throw new Error("TaskObject.addEventToCurrentScene: No current scene object");if(void 0===this.currentSceneObject.stateManager)throw new Error("TaskObject.addEventToCurrentScene: No stateManager in currentSceneObject");this.currentSceneObject.stateManager.addEvent(e)}},{key:"create2DScene",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,k.mandatory)(),t={sceneKey:"scene"+1e5*Math.random(),canvasBackground:new u.BABYLON.Color4(0,0,0,1),backgroundRoundRadius:50,clearColor:new u.BABYLON.Color4(0,0,0,1),canvasPercentWidth:.8,canvasPercentHeight:1};e=l.default.extend(t,e);var n=new u.BABYLON.Scene(this.engine);n.sceneKey=e.sceneKey,n.parentTaskObject=this,this.addStateManager(n),n.clearColor=e.clearColor;var a=new u.BABYLON.ArcRotateCamera("Camera",0,Math.PI/2,12,u.BABYLON.Vector3.Zero(),n),r=new u.BABYLON.ScreenSpaceCanvas2D(n,{id:"ScreenCanvas",backgroundFill:u.BABYLON.Canvas2D.GetSolidColorBrush(e.canvasBackground),backgroundRoundRadius:e.backgroundRoundRadius,fill:u.BABYLON.Canvas2D.GetSolidColorBrush(e.canvasBackground),x:this.renderSize.width/2-this.renderSize.width*e.canvasPercentWidth/2,y:this.renderSize.height/2-this.renderSize.height*e.canvasPercentHeight/2,size:new u.BABYLON.Size(this.renderSize.width*e.canvasPercentWidth,this.renderSize.height*e.canvasPercentHeight),zOrder:1});n.initialCanvas=r,n.initialCamera=a,void 0!==M.DEBUG_MODE_ON&&M.DEBUG_MODE_ON===!0&&r.createCanvasProfileInfoCanvas();var i=function(){this.initialCanvas.x=this.parentTaskObject.renderSize.width/2-this.initialCanvas.size.width/2,this.initialCanvas.y=this.parentTaskObject.renderSize.height/2-this.initialCanvas.size.height/2};return n.updateContentFrame=i,n.registerBeforeRender(function(){n.stateManager.update()}),n}},{key:"getContext",value:function(e){var t=void 0!==this.currentSceneObject?this.currentSceneObject:null,n=null!==t&&void 0!==t.stateManager?t.stateManager:null,a=null!==n&&void 0!==n.currentState?this.currentSceneObject.stateManager.currentState:null,r={taskObject:this,dataManager:void 0!==this.dataManager?this.dataManager:null,scene:t,stateManager:n,state:a,R:this.R};if(void 0===e)return r;var i={};switch(e.constructor){case u.BABYLON.Scene:i={scene:e,stateManager:e.stateManager,state:e.stateManager.currentState};break;case p.default:i={scene:e._parent,stateManager:e,state:e.currentState};break;case w.default:i={scene:e._parent,stateManager:e._stateManager,state:e};break;default:return(0,k.debugWarn)("TaskObject.getContext: object is not of valid class. Returning taskObject context."),r}return l.default.extend(r,i)}},{key:"toggleDebugLayer",value:function(){var e=this.currentSceneObject;this.shouldShowDebug=!this.shouldShowDebug,void 0!==e?this.shouldShowDebug?(this.scenes[this._currentSceneKey].debugLayer.show(),void 0!==this.scenes[this._currentSceneKey].initialCanvas&&this.scenes[this._currentSceneKey].initialCanvas.createCanvasProfileInfoCanvas()):(this.scenes[this._currentSceneKey].debugLayer.hide(),void 0!==this.scenes[this._currentSceneKey].initialCanvas&&null!==this.scenes[this._currentSceneKey].initialCanvas._profilingCanvas&&(this.scenes[this._currentSceneKey].initialCanvas._profilingCanvas.dispose(),this.scenes[this._currentSceneKey].initialCanvas._profilingCanvas=null)):console.error("taskObject.toggleDebugLayer: currentSceneObject is undefined")}},{key:"newInfoModal",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,k.mandatory)();this._currentModal=e;var t=this,n=new d.SmartModal("centralSmall",function(){t.infoModalDismissed()});n.title=e[0],n.content=e[1],this.infoModal=n}},{key:"infoModalDismissed",value:function(){if(!this._currentModal)throw new Error("infoModal not defined");var e=this._currentModal[2];switch(e[0]){case"MDASTARTTASK":e[1]();break;default:throw new Error("infoModalDismissed: Action unknown")}this.removeInfoModal()}},{key:"removeInfoModal",value:function(){if(!this.infoModal)throw new Error("Can't remove InfoModal, infoModal not set");switch(this.infoModal.constructor.name){case"SmartModal":break;default:throw new Error("Invalid infoModal type")}this.infoModal=null,this._currentModal=null}},{key:"animateFloat",value:function(e,t,n,a){var r=[{frame:0,value:n},{frame:100,value:a}],i=new u.BABYLON.Animation("animation",t,100,u.BABYLON.Animation.ANIMATIONTYPE_FLOAT,u.BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);i.setKeys(r),this.currentSceneObject.stopAnimation(e),e.animations.push(i),e._scene.beginAnimation(e,0,100,!1,1,function(){})}},{key:"animateVector3",value:function(e,t,n,a){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:24,i=[{frame:0,value:n},{frame:r,value:a}],o=new u.BABYLON.Animation("animation",t,24,u.BABYLON.Animation.ANIMATIONTYPE_VECTOR3,u.BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);o.setKeys(i),this.currentSceneObject.stopAnimation(e),e.animations.push(o)}},{key:"animateColor3",value:function(e,t,n,a){var r=[{frame:0,value:n},{frame:24,value:a}],i=new u.BABYLON.Animation("animation",t,12,u.BABYLON.Animation.ANIMATIONTYPE_COLOR3,u.BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);i.setKeys(r),e._scene.stopAnimation(e),e.animations.push(i)}},{key:"animateMainCameraRotation",value:function(e,n,a){a=this.scenes[this.currentScene];var r=new u.BABYLON.Animation("animCam","alpha",60,u.BABYLON.Animation.ANIMATIONTYPE_FLOAT,u.BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT),i=a.activeCamera,o=[];if(t.overPI(i.alpha,e)){o.push({frame:0,value:i.alpha}),console.log(i.alpha),console.log(e);var s=-Math.PI,l=Math.PI;i.alpha>0&&(s=Math.PI,l=-Math.PI),o.push({frame:50,value:s}),o.push({frame:51,value:l}),o.push({frame:100,value:e})}else o.push({frame:0,value:i.alpha}),o.push({frame:100,value:e});var d=new u.BABYLON.Animation("animCam","beta",60,u.BABYLON.Animation.ANIMATIONTYPE_FLOAT,u.BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT),c=[];c.push({frame:0,value:i.beta}),c.push({frame:100,value:n}),r.setKeys(o),d.setKeys(c),i.animations.push(r),i.animations.push(d),a.beginAnimation(i,0,100,!1,1,function(){})}},{key:"addParticuleSystemTo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,k.mandatory)(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(void 0===e._scene)throw new Error("addParticuleSystemTo: mesh _scene is undefined.");var n=e._scene,a={name:"particle"+e.name,capacity:2e3,texture:this.ASSETS_FLARE_PATH,minEmitBox:null,maxEmitBox:null,color1:new u.BABYLON.Color4(.7,.8,1,1),color2:new u.BABYLON.Color4(.2,.5,1,1),colorDead:new u.BABYLON.Color4(0,0,.2,0),minSize:.1,maxSize:.5,minLifeTime:.3,maxLifeTime:.8,emitRate:150,blendMode:u.BABYLON.ParticleSystem.BLENDMODE_ONEONE,gravity:new u.BABYLON.Vector3(0,9.81,0),direction1:new u.BABYLON.Vector3(-5,-1,3),direction2:new u.BABYLON.Vector3(5,1,-3),minAngularSpeed:0,maxAngularSpeed:2*Math.PI,minEmitPower:.1,maxEmitPower:.1,updateSpeed:.01,startIt:!1};t=l.default.extend(a,t);var r=new u.BABYLON.ParticleSystem("particles",t.capacity,n);return r.particleTexture=new u.BABYLON.Texture(t.texture,n),r.emitter=e,null!==t.minEmitBox&&(r.minEmitBox=t.minEmitBox),null!==t.maxEmitBox&&(r.maxEmitBox=t.maxEmitBox),r.color1=t.color1,r.color2=t.color2,r.colorDead=t.colorDead,r.minSize=t.minSize,r.maxSize=t.maxSize,r.minLifeTime=t.minLifeTime,r.maxLifeTime=t.maxLifeTime,r.emitRate=t.emitRate,r.blendMode=t.blendMode,r.gravity=t.gravity,r.direction1=t.direction1,r.direction2=t.direction2,r.minAngularSpeed=t.minAngularSpeed,r.maxAngularSpeed=t.maxAngularSpeed,r.minEmitPower=t.minEmitPower,r.maxEmitPower=t.maxEmitPower,r.updateSpeed=t.updateSpeed,t.startIt&&r.start(),r}},{key:"context",get:function(){return this.getContext()}},{key:"currentScene",get:function(){return this._currentSceneKey},set:function(e){Object.keys(this.scenes).indexOf(e)!==-1?(this.scenes[e].stateManager.goToState(this.R.get.states_active),void 0!==M.DEBUG_MODE_ON&&M.DEBUG_MODE_ON===!0&&this.shouldShowDebug&&(this.scenes[e].debugLayer.show(),void 0!==this.scenes[e].initialCanvas&&this.scenes[e].initialCanvas.createCanvasProfileInfoCanvas()),this._currentSceneKey&&(this.scenes[this._currentSceneKey].stateManager.goToState(this.R.get.states_idle),void 0!==M.DEBUG_MODE_ON&&M.DEBUG_MODE_ON===!0&&(this.scenes[this._currentSceneKey].debugLayer.hide(),void 0!==this.scenes[this._currentSceneKey].initialCanvas&&null!==this.scenes[this._currentSceneKey].initialCanvas._profilingCanvas&&(this.scenes[this._currentSceneKey].initialCanvas._profilingCanvas.dispose(),this.scenes[this._currentSceneKey].initialCanvas._profilingCanvas=null))),this._currentSceneKey=e,(0,k.debuglog)("TaskObject.currentScene: changed to "+e)):null===e||""===e?this._currentSceneKey="":console.error("TaskObject.currentScene: Invalid sceneKey.")}},{key:"currentSceneObject",get:function(){return this.scenes[this._currentSceneKey]},set:function(e){if(!l.default.has(e,"sceneKey"))throw new Error("Specified scene has no sceneKey");this.currentScene=e.sceneKey}},{key:"time",get:function(){return this.timeInMs}},{key:"timeInSec",get:function(){return(new Date).getTime()/1e3}},{key:"timeInMs",get:function(){return(new Date).getTime()}},{key:"paramBox",get:function(){return this._paramBox},set:function(e){this._paramBox&&this._paramBox.delete(),this._paramBox=e}},{key:"renderSize",get:function(){return new u.BABYLON.Size(this.engine.getRenderWidth(),this.engine.getRenderHeight())},set:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,k.mandatory)();switch(e.constructor){case k.String:this.canvas.width=e,this.canvas.height=e;break;case u.BABYLON.Size:this.canvas.width=e.width+"px",this.canvas.height=e.height+"px";break;case k.Array:if(2!==e.length)throw new Error("TaskObject.renderSize: set with invalid size array, array lenght has to be === 2.");this.canvas.width=e[0],this.canvas.height=e[1];break;default:throw new Error("TaskObject.renderSize: set with invalid size array, array lenght has to be === 2.")}}}],[{key:"borderPI",value:function(e){var t=Math.PI;return(e+=t)-Math.sign(e)*Math.floor(Math.abs(e)/(2*Math.PI))*(2*Math.PI)-t}},{key:"checkForCloserSignedAngle",value:function(e,n){n=t.borderPI(n),console.log(n),console.log("baseAngle:"+e);var a=Math.sign(n);0===n&&(a=Math.sign(e));var r=n-a*(2*Math.PI);return console.log("signedAngle:"+r),Math.abs(e-n)<=Math.abs(e-r)?n:r}},{key:"overPI",value:function(e,t){return Math.abs(e-t)>Math.PI}},{key:"fillArray",value:function(e,t){for(var n=[],a=1;a<=t;a++)n.push(e);return n}},{key:"sphericalToEuclidian",value:function(e,t,n){var a=e*Math.sin(t)*Math.cos(n),r=e*Math.sin(t)*Math.sin(n),i=e*Math.cos(t);return new u.BABYLON.Vector3(r,i,a)}},{key:"getRandomArbitrary",value:function(e,t){return Math.random()*(t-e)+e}},{key:"getRandomElement",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,k.mandatory)();if(e.constructor===k.Array)return e[Math.round(t.getRandomArbitrary(0,e.length-1))];throw new Error("TaskObject: argument is not of type array.")}},{key:"currentScene",get:function(){}},{key:"currentSceneObject",get:function(){}},{key:"paramBox",get:function(){}},{key:"renderSize",get:function(){}}]),t}();t.default=_}).call(t,n(10))},function(e,t){function n(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function r(e){if(d===setTimeout)return setTimeout(e,0);if((d===n||!d)&&setTimeout)return d=setTimeout,setTimeout(e,0);try{return d(e,0)}catch(t){try{return d.call(null,e,0)}catch(t){return d.call(this,e,0)}}}function i(e){if(c===clearTimeout)return clearTimeout(e);if((c===a||!c)&&clearTimeout)return c=clearTimeout,clearTimeout(e);try{return c(e)}catch(t){try{return c.call(null,e)}catch(t){return c.call(this,e)}}}function o(){v&&g&&(v=!1,g.length?f=g.concat(f):y=-1,f.length&&s())}function s(){if(!v){var e=r(o);v=!0;for(var t=f.length;t;){for(g=f,f=[];++y<t;)g&&g[y].run();y=-1,t=f.length}g=null,v=!1,i(e)}}function l(e,t){this.fun=e,this.array=t}function u(){}var d,c,h=e.exports={};!function(){try{d="function"==typeof setTimeout?setTimeout:n}catch(e){d=n}try{c="function"==typeof clearTimeout?clearTimeout:a}catch(e){c=a}}();var g,f=[],v=!1,y=-1;h.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];f.push(new l(e,t)),1!==f.length||v||r(s)},l.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=u,h.addListener=u,h.once=u,h.off=u,h.removeListener=u,h.removeAllListeners=u,h.emit=u,h.binding=function(e){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(e){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}},function(e,t){e.exports=n},function(e,t){e.exports=a},function(e,t){e.exports=r},function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.noop=t.debugError=t.debugWarn=t.debuglog=t.mandatory=t.mustBeDefined=t.mustHaveConstructor=t.looksLikeAPromise=t.delay=t.jitter=t.recurse=t.Deferred=t.rep=t.samplePermutation=t.matrix=t.getRow=t.rowSum=t.diag=t.String=t.Array=t.RessourceManager=t.DataManager=t.EventData=t.State=t.StateManager=t.TaskObject=void 0;var r=n(9),i=a(r),o=n(6),s=a(o),l=n(5),u=a(l),d=n(2),c=a(d),h=n(3),g=a(h),f=n(4),v=a(f),y=n(0);"undefined"!=typeof window&&(window.TaskObject=i.default,window.StateManager=s.default,window.State=u.default,window.EventData=c.default,window.DataManager=g.default,window.RessourceManager=v.default,window.jitter=y.jitter,window.delay=y.delay,window.Deferred=y.Deferred),t.TaskObject=i.default,t.StateManager=s.default,t.State=u.default,t.EventData=c.default,t.DataManager=g.default,t.RessourceManager=v.default,t.Array=y.Array,t.String=y.String,t.diag=y.diag,t.rowSum=y.rowSum,t.getRow=y.getRow,t.matrix=y.matrix,t.samplePermutation=y.samplePermutation,t.rep=y.rep,t.Deferred=y.Deferred,t.recurse=y.recurse,t.jitter=y.jitter,t.delay=y.delay,t.looksLikeAPromise=y.looksLikeAPromise,t.mustHaveConstructor=y.mustHaveConstructor,t.mustBeDefined=y.mustBeDefined,t.mandatory=y.mandatory,t.debuglog=y.debuglog,t.debugWarn=y.debugWarn,t.debugError=y.debugError,t.noop=y.noop}])});